{
	"name": "m_pre_dim_currency",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Other",
						"type": "DatasetReference"
					},
					"name": "HlpExchangeRateToUsd"
				},
				{
					"dataset": {
						"referenceName": "Other",
						"type": "DatasetReference"
					},
					"name": "tCrossReference"
				},
				{
					"dataset": {
						"referenceName": "pre_dim_currency",
						"type": "DatasetReference"
					},
					"name": "PreDimCurrencyInput"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "pre_dim_currency",
						"type": "DatasetReference"
					},
					"name": "preDimCurrency"
				}
			],
			"transformations": [
				{
					"name": "FilterDates",
					"description": "Filtering rows on 'EXCHANGE_FROM_DATE' <= currentTimestamp"
				},
				{
					"name": "ExchangeRateToUSD"
				},
				{
					"name": "xrefCurrency"
				},
				{
					"name": "SelectExhangeRate",
					"description": "Removing unused columns"
				},
				{
					"name": "GetNewestExchangeDates",
					"description": "Get newest ExchangeFromDate for each currency"
				},
				{
					"name": "JoinNewestRateWithDate",
					"description": "Inner join to get newest exchange rate for each currency"
				},
				{
					"name": "LastKnownRate"
				},
				{
					"name": "RemoveUnusedColumns"
				},
				{
					"name": "Deduplicate"
				},
				{
					"name": "RemoveExtraColumn"
				},
				{
					"name": "ExpUSD"
				},
				{
					"name": "LookupAllCurrencies"
				},
				{
					"name": "SelectOutputColums"
				},
				{
					"name": "AddNAvalues"
				},
				{
					"name": "SelectBusinessKey"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "SelectOutputColumns"
				},
				{
					"name": "LookupExistingRows"
				}
			],
			"script": "source(output(\n\t\tFROM_CURRENCY_ID as double,\n\t\tTO_CURRENCY_ID as double,\n\t\tEXCHANGE_FROM_DATE as timestamp,\n\t\tEXCHANGE_RATE as decimal(38,18),\n\t\tEXCHANGE_TO_DATE as timestamp,\n\t\tFROM_CURRENCY_CODE as string,\n\t\tTO_CURRENCY_CODE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> HlpExchangeRateToUsd\nsource(output(\n\t\tSOURCE_CODE_KEY as string,\n\t\tSOURCE_SYSTEM as string,\n\t\tTARGET_CODE as string,\n\t\tTARGET_DESCRIPTION as string,\n\t\tCODE_TYPE as string,\n\t\tCODE_TYPE_ID as double,\n\t\tCODE2 as string,\n\t\tOM_X_REF as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> tCrossReference\nsource(output(\n\t\tcur_code as string,\n\t\tcur_description as string,\n\t\tcurr_last_exchange_rate_to_usd as decimal(12,2),\n\t\tlast_updatet_by as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet',\n\twildcardPaths:['Pre_Dim/pre_dim_currency.parquet']) ~> PreDimCurrencyInput\nExchangeRateToUSD filter(exchange_from_date <= currentTimestamp()) ~> FilterDates\nHlpExchangeRateToUsd select(mapColumn(\n\t\texchange_from_date = EXCHANGE_FROM_DATE,\n\t\texchange_rate = EXCHANGE_RATE,\n\t\tfrom_currency_code = FROM_CURRENCY_CODE,\n\t\tto_currency_code = TO_CURRENCY_CODE\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> ExchangeRateToUSD\nRemoveUnusedColumns filter(code_type_id == 124) ~> xrefCurrency\nExchangeRateToUSD select(mapColumn(\n\t\texchange_rate,\n\t\tfrom_currency_code,\n\t\texchange_from_date\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectExhangeRate\nFilterDates aggregate(groupBy(from_currency_code),\n\tEXCHANGE_FROM_DATE = max(exchange_from_date)) ~> GetNewestExchangeDates\nGetNewestExchangeDates, SelectExhangeRate join(GetNewestExchangeDates@from_currency_code == SelectExhangeRate@from_currency_code\n\t&& GetNewestExchangeDates@EXCHANGE_FROM_DATE == SelectExhangeRate@exchange_from_date,\n\tjoinType:'inner',\n\tbroadcast: 'none')~> JoinNewestRateWithDate\nRemoveExtraColumn derive(exchange_rate = case(exchange_rate==0, toDecimal(null()),toDecimal(exchange_rate))) ~> LastKnownRate\ntCrossReference select(mapColumn(\n\t\ttarget_code = TARGET_CODE,\n\t\ttarget_description = TARGET_DESCRIPTION,\n\t\tcode_type_id = CODE_TYPE_ID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RemoveUnusedColumns\nxrefCurrency aggregate(groupBy(target_code),\n\ttarget_description = first(target_description)) ~> Deduplicate\nJoinNewestRateWithDate select(mapColumn(\n\t\tfrom_currency_code = GetNewestExchangeDates@from_currency_code,\n\t\texchange_rate,\n\t\tfrom_currency_code = SelectExhangeRate@from_currency_code,\n\t\texchange_from_date = SelectExhangeRate@exchange_from_date\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RemoveExtraColumn\nAddNAvalues derive(curr_last_exchange_rate_to_usd = case(target_code=='USD', toDecimal(1), exchange_rate),\n\t\tlast_updated_by = 'pre_dim_currency') ~> ExpUSD\nDeduplicate, LastKnownRate lookup(target_code == from_currency_code,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'none')~> LookupAllCurrencies\nExpUSD select(mapColumn(\n\t\tcur_code = target_code,\n\t\tcur_description = target_description,\n\t\tcurr_last_exchange_rate_to_usd,\n\t\tlast_updated_by\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectOutputColums\nLookupAllCurrencies derive(from_currency_code = case(isMatch(), from_currency_code, 'N/A')) ~> AddNAvalues\nPreDimCurrencyInput select(mapColumn(\n\t\tcur_code2 = cur_code\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectBusinessKey\nLookupExistingRows split(!isNull(cur_code2),\n\tdisjoint: false) ~> ConditionalSplit1@(existingRows, newRows)\nConditionalSplit1@newRows select(mapColumn(\n\t\tcur_code,\n\t\tcur_description,\n\t\tcurr_last_exchange_rate_to_usd,\n\t\tlast_updated_by\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectOutputColumns\nSelectOutputColums, SelectBusinessKey lookup(cur_code == cur_code2,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'none')~> LookupExistingRows\nConditionalSplit1@existingRows sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet',\n\tpartitionFileNames:['pre_dim_currency.parquet'],\n\tpartitionBy('hash', 1),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> preDimCurrency"
		}
	}
}